import React, { useState, useMemo, useEffect, useRef } from 'react';
import {
  ChefHat, Search, Loader2, Plus, CheckCircle, Trash2,
  Save as SaveIcon, User, X, Moon, Sun, RefreshCw, ClipboardType, AlignLeft, Edit2,
  Camera, Link as LinkIcon, Layers, Bug, Key, Maximize2, Wifi, WifiOff, CloudLightning, Settings, Database, AlertTriangle, Download, Upload, CloudOff, ShieldAlert,
  Cloud, PenTool
} from 'lucide-react';

// Firebase Imports
import { initializeApp, getApps, getApp } from 'firebase/app';
import {
  getAuth, signInAnonymously, onAuthStateChanged,
  signInWithCustomToken, GoogleAuthProvider, signInWithPopup,
  signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  updateProfile
} from 'firebase/auth';
import {
  getFirestore, collection, doc, onSnapshot, updateDoc,
  deleteDoc, addDoc, setDoc, enableIndexedDbPersistence,
  disableNetwork, enableNetwork, getDocs, initializeFirestore,
  terminate, clearIndexedDbPersistence, waitForPendingWrites
} from 'firebase/firestore';

/**
 * --- CONFIGURATION & INITIALIZATION ---
 */
const initializeFirebase = () => {
  let app, auth, db, googleProvider;
  let initError = null;
  let isDummyConfig = false;

  try {
    let firebaseConfig;
    if (typeof __firebase_config !== 'undefined') {
      if (typeof __firebase_config === 'string') {
        try {
          firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
          console.warn("Failed to parse __firebase_config");
        }
      } else {
        firebaseConfig = __firebase_config;
      }
    }

    if (!firebaseConfig) {
      firebaseConfig = {
        apiKey: "AIzaSyCLATlr-23t3HYoH0euBtZ7IG4IM5DLVPM",
        authDomain: "recipe-matcher-3e89d.firebaseapp.com",
        projectId: "recipe-matcher-3e89d",
        storageBucket: "recipe-matcher-3e89d.firebasestorage.app",
        messagingSenderId: "414903191846",
        appId: "1:414903191846:web:b0652a25fd957b2f42d9e7",
        measurementId: "G-0CLB5VSR5F"
      };
    }

    if (!getApps().length) {
      app = initializeApp(firebaseConfig);
      
      // Mobile Connectivity Fix: Allow Manual Override via LocalStorage
      const storedPolling = localStorage.getItem('rm_force_polling');
      const isMobileUA = typeof navigator !== 'undefined' && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      // Use Long Polling if manually set OR if detected as mobile (and not manually disabled)
      const useLongPolling = storedPolling === 'true' || (isMobileUA && storedPolling !== 'false');

      db = initializeFirestore(app, {
        experimentalForceLongPolling: useLongPolling,
      });

      console.log(`[Firebase] Initialized. LongPolling: ${useLongPolling} (UserAgent: ${isMobileUA}, Manual: ${storedPolling})`);

      enableIndexedDbPersistence(db).then(() => {
          console.log("[Firebase] Persistence enabled");
      }).catch((err) => {
          console.warn("Persistence failed (common in private/incognito windows):", err.code);
      });
    } else {
      app = getApp();
      db = getFirestore(app);
    }

    auth = getAuth(app);
    googleProvider = new GoogleAuthProvider();

  } catch (e) {
    console.error("Critical Init Error:", e);
    initError = e.message;
    isDummyConfig = true;
  }

  return { app, auth, db, googleProvider, initError, isDummyConfig };
};

// Initialize once
const fb = initializeFirebase();

const appId = typeof __app_id !== 'undefined' ? __app_id : 'recipe-matcher-v2';

// --- DATA: MASTER INGREDIENT LIST ---
const MASTER_INGREDIENTS = {
  "Meats": [
    "Ground Beef", "Beef Ribeye", "Beef Brisket", "Chuck Roast", "Beef Stew Meat", "Flank Steak",
    "Pork Shoulder", "Pork Chop", "Pork Belly", "Bacon", "Pancetta", "Prosciutto", "Ham",
    "Sausage", "Bratwurst", "Frankfurter", "Chorizo", "Italian Sausage", "Pepperoni", "Ground Pork",
    "Chicken Breast", "Chicken Thigh", "Chicken Wing", "Whole Turkey", "Duck", "Shrimp", "Salmon",
    "Cod", "Tuna", "Anchovy", "Clam", "Squid", "Crab", "Tofu", "Lamb", "Liver",
    "Sirloin Steak", "Pork"
  ],
  "Produce": [
    "Onion", "Red Onion", "Garlic", "Ginger", "Scallion", "Shallot", "Lemongrass", "Celery",
    "Carrot", "Bell Pepper", "Jalapeño", "Poblano", "Serrano Pepper", "Bird’s Eye Chili",
    "Roma Tomato", "Tomatillo", "Russet Potato", "Cabbage",
    "Bok Choy", "Broccoli", "Cauliflower", "Corn", "Button Mushroom", "Shiitake Mushroom", "Eggplant",
    "Zucchini", "Cucumber", "Spinach", "Kale", "Green Bean", "Snow Pea", "Asparagus", "Radish",
    "Bean Sprout", "Avocado", "Lime", "Lemon", "Apple", "Mango", "Pineapple", "Coconut", "Tamarind",
    "Fresh Basil", "Thai Basil", "Holy Basil", "Cilantro", "Parsley", "Dill", "Chives", "Mint", "Green Pea",
    "Portabella Mushroom", "Mushrooms", "Potatoes", "Red Pepper"
  ],
  "Pantry": [
    "Dried Ancho Chili", "Dried Red Chili", "Jasmine Rice", "White Rice", "Brown Rice", "Arborio Rice", "Sticky Rice", "Gnocchi",
    "Pasta", "Egg Noodle", "Rice Noodle", "Glass Noodle", "Corn Tortilla", "Flour Tortilla",
    "White Bread", "Rye Bread", "Breadcrumbs", "Cornmeal", "Masa Harina", "Oats", "All-Purpose Flour",
    "Cornstarch", "Potato Starch", "Baking Powder", "Baking Soda", "Yeast", "Chicken Stock", "Beef Stock", "Chicken Broth",
    "Canned San Marzano Tomato", "Tomato Paste", "Tomato Sauce", "Coconut Milk", "Coconut Cream",
    "Pickle", "Sauerkraut", "Capers", "Black Olive", "Peanut Butter", "Roasted Peanut", "Walnut",
    "Pine Nut", "Almond", "Vegetable Oil", "Canola Oil", "Olive Oil", "Lard", "Sesame Oil", "Peanut Oil", "Coconut Oil",
    "White Vinegar", "Apple Cider Vinegar", "Balsamic Vinegar", "Red Wine Vinegar", "Rice Vinegar", "Rice Wine Vinegar",
    "Black Vinegar", "Honey", "Maple Syrup", "Sugar", "Brown Sugar", "Palm Sugar", "Semi-sweet Chocolate",
    "Cocoa Powder", "Vanilla Extract", "Powdered Sugar", "Gelatin", "Chicken Bouillon", "Lasagna Sheet",
    "Taco Shell", "Tortilla Chip", "Sesame Seed", "Dried Cranberry", "Almond Flour", "Molasses", "Agave Nectar",
    "Cream of Chicken Soup", "Cream of Mushroom Soup", "Pimentos", "Beef Bouillon", "Noodles", "Diced Tomatoes", "Spaghetti", "Rice", "Long Grain Rice"
  ],
  "Dairy": [
    "Whole Milk", "Heavy Cream", "Sour Cream", "Yogurt", "Buttermilk", "Condensed Milk", "Evaporated Milk",
    "Cheddar Cheese", "Low Moisture Mozzarella", "Fresh Mozzarella", "Parmesan Cheese", "Ricotta Cheese",
    "Provolone Cheese", "Monterey Jack Cheese", "Queso Fresco", "Cotija Cheese", "Oaxaca Cheese",
    "Swiss Cheese", "Cream Cheese", "Gouda Cheese", "Butter", "Egg",
    "Milk"
  ],
  "Sauces": [
    "Soy Sauce", "Dark Soy Sauce", "Oyster Sauce", "Fish Sauce", "Hoisin Sauce", "Chili Garlic Sauce",
    "Sriracha", "Worcestershire Sauce", "Ketchup", "Yellow Mustard", "Dijon Mustard", "Mayonnaise",
    "BBQ Sauce", "Hot Sauce", "Salsa", "Mole Paste", "Red Curry Paste", "Green Curry Paste", "Shrimp Paste",
    "Tamarind Paste", "Broad Bean Paste", "Miso", "Sweet Chili Sauce", "Plum Sauce", "Black Bean Sauce",
    "Ranch Dressing", "Blue Cheese Dressing", "Caesar Dressing", "Horseradish",
    "Enchilada Sauce"
  ],
  "Seasonings": [
    "Salt", "Black Pepper", "White Pepper", "Cumin", "Chili Powder", "Sweet Paprika", "Smoked Paprika",
    "Cayenne Pepper", "Red Pepper Flake", "Mexican Oregano", "Dried Oregano", "Dried Basil", "Thyme",
    "Rosemary", "Sage", "Bay Leaf", "Cinnamon", "Nutmeg", "Clove", "Allspice", "Caraway Seed",
    "Fennel Seed", "Ground Coriander", "Turmeric", "Star Anise", "Sichuan Peppercorn", "Five Spice Powder",
    "Garlic Powder", "Onion Powder", "MSG", "Curry Powder", "Italian Seasoning", "Taco Seasoning", "Saffron",
    "Pepper"
  ],
  "Other": [
    "Red Wine", "White Wine", "Shaoxing Wine", "Beer",
    "Sherry", "Water"
  ]
};

const CATEGORY_TABS = Object.keys(MASTER_INGREDIENTS);

/**
 * --- HELPERS ---
 */
const toTitleCase = (str) => {
  if (!str) return "";
  return String(str).toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
};

const parseAndSanitizeAIJSON = (text) => {
  try {
    return JSON.parse(text);
  } catch (e) {
    try {
      const cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
      return JSON.parse(cleaned);
    } catch (e2) {
      const match = text.match(/\{[\s\S]*\}/);
      if (match) {
        try {
          return JSON.parse(match[0]);
        } catch (e3) {
          throw new Error("Found JSON-like block but failed to parse.");
        }
      }
      throw new Error("Invalid JSON format from AI.");
    }
  }
};

/**
 * --- COMPONENTS ---
 */

// Auto-Expanding Textarea Component
const AutoTextarea = ({ value, onChange, className, placeholder }) => {
  const textareaRef = useRef(null);

  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
    }
  }, [value]);

  return (
    <textarea
      ref={textareaRef}
      className={
